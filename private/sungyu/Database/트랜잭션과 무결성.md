# 트랜잭션과 무결성

### 트랜잭션(Transaction)
: 데이터베이스에서 하나의 논리적인 작업을 수행하기 위한 단위로,  
논리적인 이유로 여러 SQL문들을 단일 작업으로 묶는 것을 말한다.  

ex)  
**A가 B에게 100만원을 송금하는 상황**  
1. A의 잔고 잔액을 조회한다.  
2. A의 잔고에서 100만원을 뺀다.  
3. B의 잔고에 100만원을 추가한다.  

위 작업들 중 일부만 실행되거나 실행되지 않는다면 문제가 발생할 것이다.  
따라서 위 작업들은 논리적으로 하나의 작업으로 묶여서 실행되어야 한다.  

<br>

**커밋**(Commit)  
> 여러 쿼리가 성공적으로 처리되었을 때, 작업 내용을 DB에 영구적으로 저장하는 명령어.  

위 송금 상황을 예시로 적용해본다면,  

**< Account >**
| User | Balance     |
|:----:|:-----------:|
| A    | ₩ 5,000,000 |
| B    | ₩ 0         |  
   
   ```sql
	START TRANSACTION;

	-- A의 잔고에서 100만원을 뺀다.

	UPDATE account
    SET balance = balance - 1,000,000
    WHERE User = 'A';


	-- B의 잔고에 100만원을 추가한다.

	UPDATE account
    SET balance = balance + 1,000,000
    WHERE User = 'B';


	-- 작업 내용을 DB에 영구적으로 저장

	COMMIT;
   ```  

<br>

**롤백**(Rollback)  
> 현재까지 작업들을 모두 취소하고 트랜잭션(Transaction) 이전 상태로 되돌리는 작업.  

```sql
	START TRANSACTION;

	-- A의 잔고에서 100만원을 뺀다. (오류)

	UPDATE account
    SET balance = balance - 2,000,000
    WHERE User = 'A';


	-- 작업 내용을 모두 취소하고 트랜잭션 이전 상태로 복구

	ROLLBACK;
```  

<br>

**자동 커밋**(AutoCommit)  
> 각 SQL문을 자동으로 트랜잭션 처리해주는 개념.  

- SQL문이 성공적으로 실행되면 자동으로 커밋(Commit)한다.  
- 실행 중 문제가 발생할 경우, 자동으로 롤백(Rollback)한다.  
- MySQL에서는 기본적으로 자동 커밋(AutoCommit)이 활성화 되어있다.  
- `START TRANSACTION` 실행과 동시에 자동 커밋은 비활성화 되었다가 `Commit` / `Rollback` 과 함께 트랜잭션 종료 시 원래의 자동 커밋 상태로 돌아간다.  

```sql
  START TRANSACTION;	-- AutoCommit Off


  UPDATE account
  SET balance = balance - 1,000,000
  WHERE User = 'A';


  UPDATE account
  SET balance = balance + 1,000,000
  WHERE User = 'B';


  COMMIT;	-- AutoCommit On
```  

<br>

### 트랜잭션의 특징 (ACID)  
- 원자성(**A**tomic)  
- 일관성(**C**onsistency)  
- 격리성(**I**solation)  
- 지속성(**D**urability)  

<br>

**원자성**(Atomic)  
> “All or Nothing”  

트랜잭션 내부 쿼리문의 일부만 실행되면 문제가 생기기 때문에  
모든 작업이 성공하거나, 실패할 경우 모든 작업을 취소하여 아무일도 없던 것처럼 롤백한다.  

- 개발자는 커밋(Commit) 과 롤백(Rollback) 시점을 신경써서 관리해야 한다.  

<br>

**일관성**(Consistency)  
> ’허용된 방식’ 으로만 데이터를 변경해야 한다.  

DB에 정의된 조건, 규칙을 트랜잭션이 위반했다면 롤백 해야 한다.  

- 개발자는 트랜잭션이 **DB에 정의된 규칙을 위반했는지** 예외처리(Exception)를 통해  
  에러 메시지를 출력과 롤백을 설정해야 한다.  
- 뿐만아니라 **애플리케이션 관점**에서도 일관성을 유지하도록 트랜잭션을 관리해야 한다.  

위 송금하는 경우를 예시로,  
A가 B에게 100만원을 송금할 때, **A의 잔고 잔액이 100만원 이상이 있는지 확인**하고 트랜잭션을 수행해야 한다.  
`check (balance >= 1,000,000)`  

만약 조건, 규칙에 해당하지 않는다면 롤백을 수행하여 트랜잭션 이전의 상태로 되돌린다.  

<br>

**격리성**(Isolation)  
> 여러 트랜잭션이 동시에 실행될 때, 서로 격리되어 순차적으로 실행되는 것처럼 동작하는 정도  

- DBMS는 여러 종류의 **격리성 레벨**(Isolation Level)을 제공한다.  
- 격리성 레벨이 높으면 높을 수록 독립적, 순차적으로 트랜잭션이 동작하지만 그만큼 동시에 실행할 수 있는 트랜잭션 단위가 줄어들면서 성능이 저하된다.  
- 격리성 레벨이 낮으면 낮을 수록 동시에 실행할 수 있는 트랜잭션 단위가 많아지지만, 그만큼 다른 트랜잭션의 영향을 받을 가능성 또한 커진다.  
- 개발자는 격리성 레벨 중 어떤 단계로 트랜잭션을 동작시킬지 상황에 맞게 설정할 줄 알아야 한다.  


  ◼︎ **격리성 레벨**(Isolation Level)  
  > 격리성 정도에 따라 발생할 수 있는 이상 현상을 기준으로 레벨을 선정  

  - **READ_UNCOMMITTED** (커밋되지 않은 값도 중간에 막 읽기)  
    -> Dirty Read 발생 가능  

  - **READ_COMMITTED** (커밋된 값만 읽기)  
    -> Non Reapeatable Read 발생 가능  

  - **REPEATABLE_READ** (동일한 값을 수정할 수 없도록 잠금, 새로운 행 추가 가능)  
    -> Phantom Read 발생 가능  

  - **SERIALIZABLE** (트랜잭션을 순차적으로 실행, 작업마다 데이터를 잠금)  


  ◼︎ **데이터 잠금**(Lock)  
  > 사용 중인 데이터를 읽거나 수정하지 못하게 막는 것  

  - 한 테이블 전체를 잠글 수 있다.  
  - 테이블의 한 행(Row)을 잠글 수 있다.  
    - 공유 잠금(Shared Lock) : 동시 접근 및 읽기 가능, 데이터 수정 불가  
    - 베타적 잠금(Exclusive Lock) : 동시 접근 불가, 데이터 읽기, 수정 모두 불가  

<br>

**지속성**(Durability)  
> 커밋(Commit)된 트랜잭션은 DB에 영구적으로 저장한다.  

- DB 시스템에 문제(Power fail or DB Crash) 가 발생해도 커밋된 트랜잭션은 DB에 남아있는다.  
- 일반적으로 커밋된 트랜잭션은 비휘발성 메모리 (HDD, SSD, ..)에 저장한다.  
- DBMS는 시스템 장애가 발생해도 원래 상태로 복구하기 위한 기능이 제공된다. (롤백, 체크섬, 저널링 등)  
- 기본적으로 트랜잭션의 지속성은 DBMS가 보장한다.  



### 무결성  
- **개채 무결성**(Entity Integrity)  
  : 기본키로 선택된 필드는 **고유한 값**을 가져야하고, **빈 값을 허용하지 않는다**.  
- **참조 무결성**(Referential Integrity)  
  : 참조 관계에 있는 두 테이블의 데이터는 항상 **일관된 값을 유지**해야 한다.  
- **고유 무결성**(Unique Integrity)  
  : 특정 속성에 고유한 값을 가지도록 조건이 주어진 경우, 그 속성값은 **고유한 값**을 가진다.  
- **NULL 무결성**(NULL Integrity)  
  : 특정 속성 값에 NULL이 올 수 없다는 조건이 주어진 경우, 속성값에는 **NULL이 올 수 없다**.  

<br>

References  
- [BJ.42 데이터베이스 트랜잭션\(transaction\)을 아십니까? 그리고 트랜잭션의 매우 중요한 속성들인 ACID를 아십니까? 모르신다면 들렀다 가시지요](https://youtu.be/sLJ8ypeHGlM?si=xPJphWCBvEo04YKY)


---

**ORM으로 트랜잭션을 관리/제어가 가능할까?**
- YES

**쿼리문의 마지막 ;(세미콜론) 에서 Commit 이 실행된다.**
- AUTO COMMIT 단위로 실행될 경우, 각 문장마다 커밋(Commit)이 적용된다.
