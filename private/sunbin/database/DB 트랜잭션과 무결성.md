# DB 트랜잭션과 무결성

### 트랜잭션이란?

**정의**

직역하면 “거래”이다. 컴퓨터 과학 분야에서는 나눌 수 없는 최소한의 작업 단위를 말한다.

하나의 작업을 위해 더 이상 분할 될 수 없는 명령들의 모음,

한꺼번에 수행되어야 할 일련의 연산 모음을 의미한다.

트랜잭션이 필요한 이유를 사례를 통해 설명할 수 있다.

<aside>

1. 부모님이 자식에게 2000원을 입금 하려 한다
2. 부모님 계좌에서는 성공적으로 2000원이 인출되었다
3. 자식 계좌에서는 2000원을 받지 못했다.
</aside>

위와 같이 인출에는 성공했지만, 입금에 실패할 경우는 치명적인 결과가 발생한다

따라서 이 두 과정은 **동시에 성공하던지 동시에 실패**하여야 한다.

**트랜잭션 흐름**

```c
1. 시작

transation;
BEGIN;

2. 여러 CRUD 실행

INSERT INTO user...
INSERT INTO alllecturedata...
INSERT INTO mydonelecture...

3. 성공시

COMMIT;

3. 실패시

ROLLBACK;
```

### 트랜잭션 특징

| 원자성 | 트랜잭션이 DB에 모두 반영되거나, 전혀 반영되지 않아야 한다. |
| --- | --- |
| 일관성 | 작업 처리 결과가 항상 일관성 있어야 한다.
트랜잭션이 진행되는 동안 DB가 변경되더라도 처음 참조한 DB를 기준으로 변경된다.

트랜잭션의 시작 전과 끝난 후에도 데이터베이스는 일관된 상태여야 한다. |
| 독립성 | 트랜잭션 2개가 동시에 실행되고 있는 경우 각 트랜잭션이 다른 트랜잭션에게 영향을 주지 못한다. |
| 영구성 | 트랜잭션이 성공했을 경우 영구적으로 반영되어야 한다. |

### 무결성이란?

**정의**

정보에 결점이 없도록 유지하는 성질

DB 내에 저장되는 데이터 값들이 항상 일관성을 갖고 데이터의 유효성, 정확성, 안정성을 유지할 수 있도록 하는 제약 조건을 두는 DB의 특징

데이터의 정확성, 유효성, 안정성이 유지 되어야 한다.

정확성이란 중복이나 누락이 없는 상태

일관성이란 원인과 결과의 의미가 연속적으로 보장되어 변하지 않는 상태

유효성이란 사용자로부터 값을 받을 때 정확한 값만 입력됨을 유도

### 트랜잭션의 이해

트랜잭션이란 개발자가 특정 흐름에 있어서 한번에 성공하거나 그렇지 않으면 전부 실패로 만들게끔 경계를 직접 설정하여 DB 무결성을 해치지 않는 실행 단위를 의미한다

사용자가 주문할 상품을 고르고 결제창에서 결제까지 완료되었지만 DB상에 결제 완료에 대한 데이터가 저장되어있지 않는 경우가 트랜잭션으로 보호 해야 하는 사례이다.

개발자가 해당 흐름 동안 하나라도 DB상의 문제가 발생한다면 Rollback하여 이전의 상태로 되돌려야 한다.

그렇다면 트랜잭션의 경계는 어떻게 설정해야하나?

**트랜잭션 범위 설정을 위한 원칙**

1. DB 내부의 흐름으로만 묶는다. CPU나 메모리를 사용하는 비즈니스 로직은 해당되지 않는다
예) PDF 추출 X
2. 하나가 실패하면 전부 실패 되어야 한다. 예) PDF → 교과목 데이터 저장
3. 트랜잭션은 짧아야 한다 → DB 락
4. 쿼리문을 나열하고 논리상 A가 없으면 B가 존재할 수 없는 경우를 찾는다.

**DB 락**
트랜잭션 특징 중 독립성에 의해서 트랜잭션이 작동 중에는 다른 작업에서 해당 DB를 접근하지 못하도록 막는다. 그렇기에 트랜잭션 자체가 길다면 동시성 급감, 서버에 치명적인 문제를 일으킨다.